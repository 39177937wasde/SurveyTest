<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>問卷顯示</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        .question-container {
            margin-bottom: 20px;
        }

        .option-container {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>問卷顯示</h1>
        <div id="questionnaire"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            // 从 URL 中获取 questionnaireID
            const urlParams = new URLSearchParams(window.location.search);
            const questionnaireID = urlParams.get('id');

            // 检查 questionnaireID 是否正确提取
            console.log("questionnaireID:", questionnaireID);

            let userId;

            // 获取当前用户 ID
            $.ajax({
                type: "GET",
                url: "/api/Survay/current-user-id",
                success: function (response) {
                    userId = response.userId;
                    if (questionnaireID) {
                        loadQuestionnaireData(userId, questionnaireID);
                    } else {
                        console.error("Invalid questionnaireID:", questionnaireID);
                        $('#questionnaire').html("<p>問卷ID無效。</p>");
                    }
                },
                error: function () {
                    alert("无法获取用户ID，请重新登录！");
                }
            });

            function loadQuestionnaireData(userId, questionnaireID) {
                $.ajax({
                    type: "GET",
                    url: `/api/Survay/get-user-questionnaires/${userId}`,
                    success: function (data) {
                        const parsedData = data.$values;
                        const questionnaire = parsedData.find(q => q.questionnaireID == questionnaireID);

                        if (questionnaire) {
                            loadQuestionnaire(questionnaire);
                        } else {
                            console.error('Questionnaire not found:', data);
                            $('#questionnaire').html("<p>沒有找到指定的問卷。</p>");
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("加载问卷失败，请重试！", textStatus, errorThrown);
                        alert("加载问卷失败，请重试！");
                    }
                });
            }

            function loadQuestionnaire(questionnaire) {
                if (!questionnaire.questions || !questionnaire.questions.$values) {
                    console.error('Invalid questionnaire data structure:', questionnaire);
                    $('#questionnaire').html("<p>無法顯示問卷的問題，請重試。</p>");
                    return;
                }

                const questions = questionnaire.questions.$values;
                const questionnaireHtml = `
                            <div class="questionnaire-container card p-3 mb-3">
                                <h2>問卷 ID: ${questionnaire.questionnaireID}</h2>
                                <h3>Tag: ${questionnaire.tag}</h3>
                                <h3>End Time: ${new Date(questionnaire.endTime).toLocaleString()}</h3>
                                <div class="questions">
                                    ${questions.map((question, index) => `
                                        <div class="question-container card p-3 mb-3">
                                            <div class="form-group">
                                                <label for="question-${question.questionID}">問題 ${index + 1}</label>
                                                <input type="text" class="form-control" id="question-${question.questionID}" value="${question.questionText}" readonly>
                                            </div>
                                            <div class="form-group question-type">
                                                <label for="question-type-${question.questionID}">問題類型</label>
                                                <input type="text" class="form-control" id="question-type-${question.questionID}" value="${question.questionType}" readonly>
                                            </div>
                                            <div class="options">
                                                ${(question.options && question.options.$values || []).map(option => `
                                                    <div class="option-container">
                                                        <input type="text" class="form-control" value="${option.optionText}" readonly>
                                                    </div>`).join('')}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                $('#questionnaire').append(questionnaireHtml);
            }
        });
    </script>
</body>
</html>
